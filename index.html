<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Molarity calculator</title>
<meta name="author" content="PT">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="version" content="1.0.1">
<link href="bootstrap/jquery-ui.min.css" rel="stylesheet">
<link href="MolarityCalculator.css" rel="stylesheet">
<link href="index.css" rel="stylesheet">
<script src="jquery-3.7.1.min.js"></script>
<script src="jquery-ui.min.js"></script>

<script>
$(document).ready(function()
{
   $("#D_AddNewMWSubstance").dialog(
   {
      title: 'Add new item',
      modal: true,
      width: 219,
      height: 158,
      position: { my: 'center', at: 'center', of: window },
      buttons:
      [
         {
            text: "Add",
            click: function()
            {
               AddNewItemToMWSelBox(EB_DialogAddNewSub_Name.value, EB_DialogAddNewSub_MW.value);
               $("#D_AddNewMWSubstance").dialog('close');
            }
         },
         {
            text: "Cancel",
            click: function()
            {
               $("#D_AddNewMWSubstance").dialog('close');
               EB_MolecularMass.value = "";
               SelB_MWselection.value = "";
            }
         }
      ],
      resizable: false,
      draggable: true,
      closeOnEscape: false,
      show: false,
      hide: false,
      autoOpen: false,
      classes: {'ui-dialog': 'D_AddNewMWSubstance'} 
   });
});
</script>
</head>


<body>
<div id="Layer1" style="position:absolute;text-align:left;left:21px;top:35px;width:376px;height:252px;z-index:19;">
<div id="wb_Shape1" style="position:absolute;left:10px;top:16px;width:339px;height:205px;z-index:0;">
<div id="Shape1"></div></div>
<input type="text" id="EB_Mass" onchange=";return false;" style="position:absolute;left:31px;top:175px;width:84px;height:18px;z-index:1;" name="Editbox1" value="" readonly autocomplete="off" spellcheck="false">
<div id="wb_TB_Mass" style="position:absolute;left:141px;top:180px;width:107px;height:18px;z-index:2;"class="no-select">
<span style="color:#000000;">Mass, g</span></div>
<input type="submit" id="BTN_Calculate" onclick="return CalculateMass();return false;" name="" value="Calculate" style="position:absolute;left:230px;top:178px;width:97px;height:23px;z-index:3;">
<div id="wb_TB_Concentration" style="position:absolute;left:141px;top:124px;width:107px;height:18px;z-index:4;"class="no-select">
<span style="color:#000000;">Concentration,</span></div>
<input type="text" id="EB_Concentration" onfocusout="EB_Concentration.value = FloatValidationMy(EB_Concentration.value);return false;" oninput="EB_Concentration.value = FilterInput(EB_Concentration.value);return false;" style="position:absolute;left:31px;top:119px;width:84px;height:18px;z-index:5;" name="Editbox1" value="" autocomplete="off" spellcheck="false">
<select name="Select1" size="1" id="SelB_Concentration" style="position:absolute;left:274px;top:120px;width:53px;height:26px;z-index:6;" autocomplete="off">
<option selected value="1">M</option>
<option value="0.001">mM</option>
<option value="0.000001">μM</option>
<option value="0.000000001">nM</option>
</select>
<div id="wb_TB_Volume" style="position:absolute;left:141px;top:93px;width:68px;height:18px;z-index:7;"class="no-select">
<span style="color:#000000;">Volume,</span></div>
<input type="text" id="EB_Volume" onfocusout="EB_Volume.value = FloatValidationMy(EB_Volume.value);return false;" oninput="EB_Volume.value = FilterInput(EB_Volume.value);return false;" style="position:absolute;left:31px;top:88px;width:84px;height:18px;z-index:8;" name="Editbox1" value="" autocomplete="off" spellcheck="false">
<select name="Select1" size="1" id="SelB_Volume" style="position:absolute;left:222px;top:89px;width:52px;height:26px;z-index:9;" autocomplete="off">
<option selected value="1">L</option>
<option value="0.001">mL</option>
<option value="0.000001">μL</option>
</select>
<div id="wb_TB_MolMass" style="position:absolute;left:141px;top:61px;width:81px;height:18px;z-index:10;"class="no-select">
<span style="color:#000000;">MW, g/mol</span></div>
<input type="text" id="EB_MolecularMass" onfocusout="EB_MolecularMass.value = FloatValidationMy(EB_MolecularMass.value);return false;" oninput="EB_MolecularMass.value = FilterInput(EB_MolecularMass.value);SelB_MWselection.value = '';return false;" style="position:absolute;left:31px;top:56px;width:84px;height:18px;z-index:11;" name="Editbox1" value="" autocomplete="off" spellcheck="false">
<div id="wb_TB_MainLabel" style="position:absolute;left:50px;top:25px;width:250px;height:18px;text-align:center;z-index:12;"class="no-select">
<span style="color:#000000;">Molarity calculator</span></div>
<select name="Select1" size="1" id="SelB_MWselection" oninput="MWSelectionBoxLogic(SelB_MWselection.value);return false;" style="position:absolute;left:222px;top:57px;width:105px;height:26px;z-index:13;" autocomplete="off">
<option selected value=""></option>
<option value="add">Add new</option>
<option value="58.44">NaCl</option>
<option value="74.55">KCl</option>
<option value="39.99">NaOH</option>
<option value="157.6">Tris-HCl</option>
<option value="120.14">Tris-base</option>
</select>
</div>
<div id="D_AddNewMWSubstance">
<input type="text" id="EB_DialogAddNewSub_Name" style="position:absolute;left:8px;top:33px;width:84px;height:18px;z-index:14;" name="Editbox1" value="" autocomplete="off" spellcheck="false">
<input type="text" id="EB_DialogAddNewSub_MW" onfocusout="EB_DialogAddNewSub_MW.value = FloatValidationMy(EB_DialogAddNewSub_MW.value);return false;" oninput="EB_DialogAddNewSub_MW.value = FilterInput(EB_DialogAddNewSub_MW.value);return false;" style="position:absolute;left:117px;top:33px;width:84px;height:18px;z-index:15;" name="Editbox1" value="" autocomplete="off" spellcheck="false">
<label for="" id="Label2" style="position:absolute;left:115px;top:7px;width:90px;height:18px;line-height:18px;z-index:16;" class="no-select">MW, g/mol:</label>
<label for="" id="Label1" style="position:absolute;left:6px;top:7px;width:90px;height:18px;line-height:18px;z-index:17;" class="no-select">Name:</label>
</div>

<script>

function CalculateMass() {
    const molecularMass = document.getElementById('EB_MolecularMass').value;
    const volume = document.getElementById('EB_Volume').value * document.getElementById('SelB_Volume').value;
    const concentration = document.getElementById('EB_Concentration').value * document.getElementById('SelB_Concentration').value;
    if (molecularMass == "" || volume == "" || concentration == "") {} else {
    const mass = molecularMass * volume *concentration;
    document.getElementById('EB_Mass').value = mass;
    }
    return true;
}

function FilterInput(str) {
    // Keep only digits and dots
    let filtered = str.replace(/[^0-9"."]/g, '');

    // Remove excess of dots
    filtered = filtered.replace(/\.(?=.*\.)/g, '');
  return filtered;
}

function FloatValidationMy(str) {
    if (str !="") {if (str==0) {return ""} else {return parseFloat(str)}
                   } else {return str}
}

function MWSelectionBoxLogic(value) {
  if (value=='add') {$("#D_AddNewMWSubstance").dialog('open');
                     document.getElementById('EB_DialogAddNewSub_Name').value = "";
                     document.getElementById('EB_DialogAddNewSub_MW').value = "";}
      else {EB_MolecularMass.value = value};
  return true;
}


function AddNewItemToMWSelBox(Name, MW) {
    const select = document.getElementById('SelB_MWselection');

    if (Name=="" || MW=="" || MW==0) {select.selectedIndex = 0; return true} else {
    const option = document.createElement('option');
    option.value = MW;
    option.textContent = Name;
    select.add(option);
    option.selected = true;
    
    SortSelectBox('SelB_MWselection');
    SaveOptions('SelB_MWselection');
    EB_MolecularMass.value = MW;
    return true;
    }
}

function SortSelectBox(selectID) {
    const select = document.getElementById(selectID);
    const selectedValue = select.value;
    const optionsHead = Array.from(select.options).slice(0, 2)
  
    const options = Array.from(select.options).slice(2).sort((a, b) => 
      a.text.localeCompare(b.text)
    );
  
    select.innerHTML = '';
    optionsHead.forEach(option => select.appendChild(option));
    options.forEach(option => select.appendChild(option));
    select.value = selectedValue;
}

function SaveOptions(selectId) {
    const select = document.getElementById(selectId);
    const options = Array.from(select.options).map(opt => ({
        value: opt.value,
        text: opt.textContent
    }));
    localStorage.setItem(selectId + '_options', JSON.stringify(options));
}

function LoadOptions(selectId) {
    const select = document.getElementById(selectId);
    const saved = localStorage.getItem(selectId + '_options');
    if (saved) {
        select.innerHTML = '';  // Clear existing
        const options = JSON.parse(saved);
        options.forEach(optData => {
            const option = document.createElement('option');
            option.value = optData.value;
            option.textContent = optData.text;
            select.appendChild(option);
        });
    }
}

window.onload = LoadOptions('SelB_MWselection')
window.onload = SortSelectBox('SelB_MWselection');

</script></body>
</html>